<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S√∫per Familiar üõí</title>
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjogIlNcdTAwZmFwZXIgRmFtaWxpYXIiLCAic2hvcnRfbmFtZSI6ICJTdXBlciIsICJzdGFydF91cmwiOiAiLiIsICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLCAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmFmN2YyIiwgInRoZW1lX2NvbG9yIjogIiNiZTE4NWQiLCAiaWNvbnMiOiBbeyJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQTFNVElnTlRFeUlpQjNhV1IwYUQwaU5URXlJaUJvWldsbmFIUTlJalV4TWlJK0NpQWdQQ0V0TFNCQ1lXTnJaM0p2ZFc1a0lDMHRQZ29nSUR4eVpXTjBJSGRwWkhSb1BTSTFNVElpSUdobGFXZG9kRDBpTlRFeUlpQnllRDBpTVRFMUlpQm1hV3hzUFNJalptTmxOMll6SWk4K0NpQWdQQ0V0TFNCRFlYSjBJR0p2WkhrZ0xTMCtDaUFnUEhCaGRHZ2daRDBpVFRFME1DQXhOakFnYURNd0lHdzBOU0F4TnpBZ2FERTJNaUJzTXpnZ0xURXlNQ0JJTWpFd0lpQm1hV3hzUFNKdWIyNWxJaUJ6ZEhKdmEyVTlJaU5pWlRFNE5XUWlJSE4wY205clpTMTNhV1IwYUQwaU1qWWlJSE4wY205clpTMXNhVzVsWTJGd1BTSnliM1Z1WkNJZ2MzUnliMnRsTFd4cGJtVnFiMmx1UFNKeWIzVnVaQ0l2UGdvZ0lEd2hMUzBnUTJGeWRDQm9ZVzVrYkdVZ0xTMCtDaUFnUEhCaGRHZ2daRDBpVFRFeU1DQXhOREFnYURRd0lpQm1hV3hzUFNKdWIyNWxJaUJ6ZEhKdmEyVTlJaU5pWlRFNE5XUWlJSE4wY205clpTMTNhV1IwYUQwaU1qWWlJSE4wY205clpTMXNhVzVsWTJGd1BTSnliM1Z1WkNJdlBnb2dJRHdoTFMwZ1YyaGxaV3h6SUMwdFBnb2dJRHhqYVhKamJHVWdZM2c5SWpJeU1pSWdZM2s5SWpNMk5TSWdjajBpTWpJaUlHWnBiR3c5SWlOaVpURTROV1FpTHo0S0lDQThZMmx5WTJ4bElHTjRQU0l6TkRJaUlHTjVQU0l6TmpVaUlISTlJakl5SWlCbWFXeHNQU0lqWW1VeE9EVmtJaTgrQ2lBZ1BDRXRMU0JKZEdWdGN5QnBiaUJqWVhKMElDaHNhWFIwYkdVZ1luVnRjSE1wSUMwdFBnb2dJRHh3WVhSb0lHUTlJazB5TXpBZ01qY3dJSEV6TUMwek1DQTJNQ0F3SUhFek1DMHpNQ0EyTUNBd0lpQm1hV3hzUFNKdWIyNWxJaUJ6ZEhKdmEyVTlJaU5pWlRFNE5XUWlJSE4wY205clpTMTNhV1IwYUQwaU1UWWlJSE4wY205clpTMXNhVzVsWTJGd1BTSnliM1Z1WkNJdlBnbzhMM04yWno0PSIsICJzaXplcyI6ICI1MTJ4NTEyIiwgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Super">
    <meta name="theme-color" content="#be185d">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiI+CiAgPCEtLSBCYWNrZ3JvdW5kIC0tPgogIDxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTE1IiBmaWxsPSIjZmNlN2YzIi8+CiAgPCEtLSBDYXJ0IGJvZHkgLS0+CiAgPHBhdGggZD0iTTE0MCAxNjAgaDMwIGw0NSAxNzAgaDE2MiBsMzggLTEyMCBIMjEwIiBmaWxsPSJub25lIiBzdHJva2U9IiNiZTE4NWQiIHN0cm9rZS13aWR0aD0iMjYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgogIDwhLS0gQ2FydCBoYW5kbGUgLS0+CiAgPHBhdGggZD0iTTEyMCAxNDAgaDQwIiBmaWxsPSJub25lIiBzdHJva2U9IiNiZTE4NWQiIHN0cm9rZS13aWR0aD0iMjYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgogIDwhLS0gV2hlZWxzIC0tPgogIDxjaXJjbGUgY3g9IjIyMiIgY3k9IjM2NSIgcj0iMjIiIGZpbGw9IiNiZTE4NWQiLz4KICA8Y2lyY2xlIGN4PSIzNDIiIGN5PSIzNjUiIHI9IjIyIiBmaWxsPSIjYmUxODVkIi8+CiAgPCEtLSBJdGVtcyBpbiBjYXJ0IChsaXR0bGUgYnVtcHMpIC0tPgogIDxwYXRoIGQ9Ik0yMzAgMjcwIHEzMC0zMCA2MCAwIHEzMC0zMCA2MCAwIiBmaWxsPSJub25lIiBzdHJva2U9IiNiZTE4NWQiIHN0cm9rZS13aWR0aD0iMTYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4=">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,400;0,700;0,900;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #faf7f2;
            --surface: #ffffff;
            --ink: #1a1a18;
            --ink-muted: #7a7770;
            --green: #2d6a4f;
            --green-light: #d8f3dc;
            --green-mid: #74c69d;
            --red: #c1121f;
            --red-light: #ffe8ea;
            --amber: #e9c46a;
            --border: #e8e3da;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        body::before {
            content: '';
            position: fixed; inset: 0;
            background-image:
                radial-gradient(circle at 20% 20%, rgba(45,106,79,0.06) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(233,196,106,0.1) 0%, transparent 50%);
            pointer-events: none; z-index: 0;
        }

        .app {
            position: relative; z-index: 1;
            width: 100%; max-width: 450px;
            background: var(--surface);
            min-height: 100vh;
            display: flex; flex-direction: column;
            box-shadow: 0 0 60px rgba(0,0,0,0.08);
        }

        /* ‚îÄ‚îÄ NAME OVERLAY ‚îÄ‚îÄ */
        #name-overlay {
            position: fixed; inset: 0;
            background: rgba(26,26,24,0.75);
            backdrop-filter: blur(6px);
            z-index: 100;
            display: none;
            place-items: center;
            padding: 20px;
        }
        .name-card {
            background: var(--surface);
            border-radius: 24px;
            padding: 32px 24px;
            width: 100%; max-width: 320px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .name-card-emoji { font-size: 2.5rem; margin-bottom: 12px; }
        .name-card h3 {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem; font-weight: 900;
            color: var(--ink); margin-bottom: 6px;
        }
        .name-card p { font-size: 0.85rem; color: var(--ink-muted); margin-bottom: 20px; }
        .user-options {
            display: flex; gap: 12px; justify-content: center;
            margin-top: 4px;
        }
        .user-option {
            flex: 1;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 18px 12px;
            cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.95rem; font-weight: 600; color: var(--ink);
            transition: all 0.2s;
        }
        .user-option:hover { border-color: var(--green-mid); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .user-opt-avatar {
            width: 52px; height: 52px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Fraunces', serif;
            font-size: 1.4rem; font-weight: 900;
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        header {
            padding: 20px 18px 16px;
            border-bottom: 1.5px solid var(--border);
            background: var(--surface);
            position: sticky; top: 0; z-index: 10;
        }
        .header-top {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 4px;
        }
        .header-title {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem; font-weight: 900;
            color: var(--ink);
        }
        .header-title span { color: var(--green); }
        .status-dot {
            width: 9px; height: 9px;
            border-radius: 50%;
            background: #94a3b8;
            transition: background 0.3s;
            flex-shrink: 0;
        }
        .status-dot.online { background: var(--green-mid); box-shadow: 0 0 0 3px rgba(116,198,157,0.3); }
        .header-sub {
            font-size: 0.78rem; color: var(--ink-muted);
            display: flex; align-items: center; gap: 10px;
        }
        #me-label {
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 20px;
            background: var(--bg);
            border: 1px solid var(--border);
            transition: all 0.2s;
            font-weight: 500;
        }
        #me-label:hover { border-color: var(--green-mid); color: var(--green); }

        /* ‚îÄ‚îÄ INPUT BAR ‚îÄ‚îÄ */
        .input-bar {
            padding: 12px 16px;
            background: var(--surface);
            border-bottom: 1.5px solid var(--border);
        }
        .input-card {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 5px 5px 5px 16px;
            display: flex; align-items: center; gap: 8px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-card:focus-within {
            border-color: var(--green-mid);
            box-shadow: 0 4px 20px rgba(45,106,79,0.12);
        }
        .input-card input {
            flex: 1; border: none; outline: none;
            background: transparent;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.97rem; color: var(--ink);
            padding: 7px 0;
        }
        .input-card input::placeholder { color: var(--ink-muted); }
        .add-btn {
            background: var(--green); color: white;
            border: none; border-radius: 11px;
            width: 38px; height: 38px;
            font-size: 1.4rem; font-weight: 300;
            cursor: pointer; flex-shrink: 0;
            transition: background 0.2s, transform 0.1s;
            display: flex; align-items: center; justify-content: center;
        }
        .add-btn:hover { background: #235c42; }
        .add-btn:active { transform: scale(0.92); }

        /* ‚îÄ‚îÄ FILTER TABS ‚îÄ‚îÄ */
        .filter-bar {
            display: flex; gap: 6px;
            padding: 10px 16px;
            border-bottom: 1.5px solid var(--border);
            overflow-x: auto; scrollbar-width: none;
        }
        .filter-bar::-webkit-scrollbar { display: none; }
        .cat-btn {
            flex-shrink: 0;
            background: var(--bg);
            border: 1.5px solid var(--border);
            border-radius: 20px;
            padding: 5px 13px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem; font-weight: 600;
            color: var(--ink-muted);
            cursor: pointer; transition: all 0.2s;
        }
        .cat-btn.active { background: var(--green); border-color: var(--green); color: white; }
        .cat-btn:hover:not(.active) { border-color: var(--green-mid); color: var(--ink); }

        /* ‚îÄ‚îÄ LIST ‚îÄ‚îÄ */
        #list { flex: 1; list-style: none; padding: 8px 0; }

        li {
            display: flex; align-items: center;
            padding: 9px 16px;
            border-bottom: 1px solid #f4f1ec;
            gap: 12px;
            transition: background 0.15s;
            animation: slideIn 0.22s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-8px); }
            to   { opacity: 1; transform: translateX(0); }
        }
        li:hover { background: #fdfcfa; }
        li.done { opacity: 0.5; }
        li.done .item-name { text-decoration: line-through; color: var(--ink-muted); }

        .check-box {
            width: 22px; height: 22px;
            border-radius: 7px;
            border: 2px solid var(--border);
            flex-shrink: 0; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .check-box:hover { border-color: var(--green-mid); }
        li.done .check-box {
            background: var(--green); border-color: var(--green);
        }
        .check-box::after {
            content: '';
            width: 5px; height: 9px;
            border-right: 2.5px solid white;
            border-bottom: 2.5px solid white;
            transform: rotate(45deg) translateY(-1px);
            display: none;
        }
        li.done .check-box::after { display: block; }

        .item-info { flex: 1; cursor: pointer; min-width: 0; }
        .item-name {
            font-size: 0.96rem; font-weight: 500;
            color: var(--ink);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .avatar {
            width: 26px; height: 26px;
            border-radius: 50%;
            background: var(--green-light);
            color: var(--green);
            font-size: 0.72rem; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            letter-spacing: 0;
        }
        li.done .avatar { opacity: 0.5; }

        .qty-stepper {
            display: flex; align-items: center; gap: 4px;
            flex-shrink: 0;
        }
        .qty-btn {
            width: 22px; height: 22px;
            border-radius: 6px;
            border: 1.5px solid var(--border);
            background: var(--bg);
            color: var(--ink-muted);
            font-size: 0.9rem; font-weight: 700;
            cursor: pointer; line-height: 1;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.15s; flex-shrink: 0;
        }
        .qty-btn:hover { border-color: var(--green-mid); color: var(--green); background: var(--green-light); }
        .qty-btn:active { transform: scale(0.88); }
        .qty-num {
            font-family: 'DM Sans', monospace;
            font-size: 0.85rem; font-weight: 700;
            color: var(--ink); min-width: 16px; text-align: center;
        }
        li.done .qty-stepper { opacity: 0.5; pointer-events: none; }
        .del-btn {
            background: none; border: none;
            color: #d4cfc8; cursor: pointer;
            font-size: 1.2rem; padding: 4px 6px;
            border-radius: 6px;
            transition: color 0.2s, background 0.2s;
            opacity: 0;
        }
        li:hover .del-btn { opacity: 1; }
        .del-btn:hover { color: var(--red); background: var(--red-light); }

        /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
        .empty {
            padding: 50px 20px;
            text-align: center; color: var(--ink-muted);
        }
        .empty-icon { font-size: 3rem; margin-bottom: 12px; }
        .empty h3 {
            font-family: 'Fraunces', serif;
            font-size: 1.2rem; color: var(--ink); margin-bottom: 6px;
        }
        .empty p { font-size: 0.85rem; }

        /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
        .footer {
            padding: 14px 18px;
            border-top: 1.5px dashed var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .footer-stat { font-size: 0.8rem; color: var(--ink-muted); }
        .footer-stat strong { color: var(--ink); }
        .btn-clear {
            background: none;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            padding: 6px 14px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem; font-weight: 600;
            color: var(--ink-muted); cursor: pointer;
            transition: all 0.2s;
        }
        .btn-clear:hover { border-color: var(--red); color: var(--red); background: var(--red-light); }

        /* ‚îÄ‚îÄ SCAN BUTTON ‚îÄ‚îÄ */
        .scan-btn {
            width: 38px; height: 38px;
            border-radius: 11px;
            border: 1.5px solid var(--border);
            background: var(--bg);
            color: var(--ink-muted);
            font-size: 1.1rem;
            cursor: pointer; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .scan-btn:hover { border-color: var(--green-mid); color: var(--green); background: var(--green-light); }
        #photo-input { display: none; }

        /* ‚îÄ‚îÄ SCAN OVERLAY ‚îÄ‚îÄ */
        #scan-overlay {
            position: fixed; inset: 0;
            background: rgba(26,26,24,0.8);
            backdrop-filter: blur(6px);
            z-index: 200;
            display: none;
            place-items: center;
            padding: 20px;
        }
        #scan-overlay.visible { display: grid; }
        .scan-card {
            background: var(--surface);
            border-radius: 24px;
            padding: 28px 22px;
            width: 100%; max-width: 340px;
            text-align: center;
        }
        .scan-card h3 {
            font-family: 'Fraunces', serif;
            font-size: 1.3rem; font-weight: 900;
            color: var(--ink); margin-bottom: 6px;
        }
        .scan-card p { font-size: 0.83rem; color: var(--ink-muted); margin-bottom: 20px; }
        .scan-preview {
            width: 100%; border-radius: 12px;
            max-height: 200px; object-fit: cover;
            margin-bottom: 16px; display: none;
        }
        .scan-spinner {
            font-size: 1.8rem;
            animation: spin 1s linear infinite;
            display: none; margin-bottom: 12px;
        }
        @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
        .scan-status { font-size: 0.85rem; color: var(--ink-muted); margin-bottom: 16px; min-height: 20px; }
        .scan-actions { display: flex; gap: 10px; }
        .btn-secondary {
            flex: 1;
            background: var(--bg); border: 1.5px solid var(--border);
            border-radius: 12px; padding: 11px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.88rem; font-weight: 600;
            color: var(--ink-muted); cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover { border-color: var(--ink-muted); color: var(--ink); }
        .scan-items-preview {
            background: var(--bg); border-radius: 10px;
            padding: 12px; margin-bottom: 16px;
            text-align: left; display: none;
            max-height: 180px; overflow-y: auto;
        }
        .scan-item-row {
            display: flex; align-items: center; gap: 8px;
            padding: 5px 0; border-bottom: 1px solid var(--border);
            font-size: 0.88rem;
        }
        .scan-item-row:last-child { border-bottom: none; }
        .scan-item-check { color: var(--green); font-weight: 700; }
    </style>
</head>
<body>

<!-- Name overlay -->
<div id="name-overlay" style="display:grid">
    <div class="name-card">
        <div class="name-card-emoji">üõí</div>
        <h3>¬øQui√©n sos?</h3>
        <p>Eleg√≠ tu perfil para continuar.</p>
        <div class="user-options">
            <button class="user-option" data-name="Mart√≠n" data-color="#1d4ed8" data-bg="#dbeafe">
                <div class="user-opt-avatar" style="background:#dbeafe;color:#1d4ed8">M</div>
                <span>Mart√≠n</span>
            </button>
            <button class="user-option" data-name="Flor" data-color="#be185d" data-bg="#fce7f3">
                <div class="user-opt-avatar" style="background:#fce7f3;color:#be185d">F</div>
                <span>Flor</span>
            </button>
        </div>
    </div>
</div>

<div class="app">
    <header>
        <div class="header-top">
            <div class="header-title">S√∫per <span>Familiar</span></div>
            <div class="status-dot" id="dot"></div>
        </div>
        <div class="header-sub">
            <span id="count-display">0 productos</span>
            <span>¬∑</span>
            <span id="me-label">cargando...</span>
            <span onclick="showApiKeyModal()" style="cursor:pointer;font-size:0.9rem;opacity:0.5" title="Configurar API Key">‚öôÔ∏è</span>
        </div>
    </header>

    <div class="input-bar" style="display:flex;gap:8px;align-items:center">
        <div class="input-card" style="flex:1">
            <input type="text" id="item-in" placeholder="Agregar producto..." autocomplete="off">
            <button class="add-btn" id="add-btn">+</button>
        </div>
        <button class="scan-btn" id="scan-btn" title="Ver foto de lista">üì∑</button>
        <input type="file" id="photo-input" accept="image/*">
    </div>

    <div id="photo-panel" style="display:none; position:relative;">
        <img id="photo-display" style="width:100%; max-height:220px; object-fit:cover; display:block; cursor:pointer;" alt="Lista de referencia">
        <button id="photo-close" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.5);color:white;border:none;border-radius:50%;width:28px;height:28px;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;">√ó</button>
    </div>

    <div class="filter-bar" id="filter-bar">
        <button class="cat-btn active" data-f="todos">Todos</button>
        <button class="cat-btn" data-f="pendientes">Pendientes</button>
        <button class="cat-btn" data-f="listos">Listos ‚úì</button>
    </div>

    <ul id="list"></ul>

    <div class="footer">
        <div class="footer-stat">
            <strong id="pct-display">0%</strong> completado
        </div>
        <button class="btn-clear" id="clear">Limpiar comprados</button>
    </div>
</div>

<!-- API Key modal -->
<div id="apikey-overlay" style="position:fixed;inset:0;background:rgba(26,26,24,0.85);backdrop-filter:blur(6px);z-index:300;display:none;place-items:center;padding:20px">
    <div style="background:white;border-radius:24px;padding:28px 22px;width:100%;max-width:340px;text-align:center">
        <div style="font-size:2rem;margin-bottom:10px">üîë</div>
        <h3 style="font-family:'Fraunces',serif;font-size:1.3rem;font-weight:900;color:#1a1a18;margin-bottom:8px">API Key de Claude</h3>
        <p style="font-size:0.82rem;color:#7a7770;margin-bottom:6px">Necesit√°s una API key de Gemini (gratis) para escanear listas.</p>
        <p style="font-size:0.78rem;color:#7a7770;margin-bottom:18px">Creala gratis en <b>aistudio.google.com/apikey</b><br>Se guarda solo en tu tel√©fono.</p>
        <div style="background:#faf7f2;border:2px solid #e8e3da;border-radius:12px;padding:4px 4px 4px 14px;display:flex;align-items:center;gap:8px;margin-bottom:14px;transition:border-color 0.2s" id="apikey-wrap">
            <input type="password" id="apikey-input" placeholder="AIza..." autocomplete="off"
                style="flex:1;border:none;outline:none;background:transparent;font-family:'DM Sans',sans-serif;font-size:0.85rem;color:#1a1a18;padding:8px 0">
            <button onclick="document.getElementById('apikey-input').type = document.getElementById('apikey-input').type==='password'?'text':'password'"
                style="background:none;border:none;cursor:pointer;font-size:1rem;padding:4px 8px;color:#7a7770">üëÅ</button>
        </div>
        <div style="display:flex;gap:10px">
            <button onclick="document.getElementById('apikey-overlay').style.display='none'"
                style="flex:1;background:#faf7f2;border:1.5px solid #e8e3da;border-radius:12px;padding:11px;font-family:'DM Sans',sans-serif;font-size:0.88rem;font-weight:600;color:#7a7770;cursor:pointer">Cancelar</button>
            <button onclick="saveApiKey()"
                style="flex:1;background:#2d6a4f;color:white;border:none;border-radius:12px;padding:11px;font-family:'DM Sans',sans-serif;font-size:0.88rem;font-weight:600;cursor:pointer">Guardar</button>
        </div>
    </div>
</div>



<script>
    const firebaseConfig = {
        apiKey: "AIzaSyANtvrq8rjzMZBS6fE49p4yLOfkD8J9Qpc",
        authDomain: "super-familiar.firebaseapp.com",
        projectId: "super-familiar",
        storageBucket: "super-familiar.firebasestorage.app",
        messagingSenderId: "152383808837",
        appId: "1:152383808837:web:28ec06dd544e9ff1220a2c",
        databaseURL: "https://super-familiar-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('lista_super');

    let myName = localStorage.getItem('super_user_v3');
    let filter = 'todos';
    let allItems = {};

    const overlay   = document.getElementById('name-overlay');
    const meLabel   = document.getElementById('me-label');
    const listEl    = document.getElementById('list');
    const dot       = document.getElementById('dot');
    const countEl   = document.getElementById('count-display');
    const pctEl     = document.getElementById('pct-display');

    // ‚îÄ‚îÄ NAME ‚îÄ‚îÄ
    // Fixed users
    const USERS = {
        'Mart√≠n': { color: '#1d4ed8', bg: '#dbeafe' },
        'Flor':   { color: '#be185d', bg: '#fce7f3' },
    };

    if (!myName) {
        overlay.style.display = 'grid';
    } else {
        showMe();
    }

    document.querySelectorAll('.user-option').forEach(btn => {
        btn.onclick = () => {
            const n = btn.dataset.name;
            localStorage.setItem('super_user_v3', n);
            myName = n;
            overlay.style.display = 'none';
            showMe();
        };
    });

    function showMe() {
        const u = USERS[myName];
        if (u) {
            meLabel.innerHTML = `<span style="display:inline-flex;align-items:center;gap:6px">
                <span style="width:16px;height:16px;border-radius:50%;background:${u.bg};border:2px solid ${u.color};display:inline-block"></span>
                ${myName}
            </span>`;
        } else {
            meLabel.innerText = 'üë§ ' + myName;
        }
    }
    meLabel.onclick = () => {
        localStorage.removeItem('super_user_v3');
        location.reload();
    };

    // ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ
    dbRef.on('value', snap => {
        dot.classList.add('online');
        allItems = snap.val() || {};
        renderList();
    });

    // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
    function renderList() {
        const keys = Object.keys(allItems);
        const filtered = keys.filter(id => {
            if (filter === 'pendientes') return !allItems[id].done;
            if (filter === 'listos')     return  allItems[id].done;
            return true;
        });

        listEl.innerHTML = '';

        if (filtered.length === 0) {
            const div = document.createElement('div');
            div.className = 'empty';
            div.innerHTML = filter === 'listos'
                ? `<div class="empty-icon">üéâ</div><h3>¬°Nada comprado a√∫n!</h3><p>Toc√° los items para marcarlos.</p>`
                : `<div class="empty-icon">ü•¨</div><h3>Lista vac√≠a</h3><p>Agreg√° el primer producto arriba.</p>`;
            listEl.appendChild(div);
        } else {
            filtered.forEach(id => {
                const item = allItems[id];
                const li = document.createElement('li');
                if (item.done) li.classList.add('done');
                const initials = (item.by || '?').trim().split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
                const userDef = USERS[item.by] || { color: '#2d6a4f', bg: '#d8f3dc' };
                const abg = userDef.bg, afg = userDef.color;
                const qty = item.qty || 1;
                li.innerHTML = `
                    <div class="check-box" onclick="toggle('${id}', ${item.done})"></div>
                    <div class="item-info" onclick="toggle('${id}', ${item.done})">
                        <div class="item-name">${escHtml(item.name)}</div>
                    </div>
                    <div class="qty-stepper">
                        <button class="qty-btn" onclick="changeQty('${id}', ${qty}, -1)">‚àí</button>
                        <span class="qty-num">${qty}</span>
                        <button class="qty-btn" onclick="changeQty('${id}', ${qty}, 1)">+</button>
                    </div>
                    <div class="avatar" style="background:${abg};color:${afg}" title="${escHtml(item.by||'Anon')}">${initials}</div>
                    <button class="del-btn" onclick="del('${id}')">√ó</button>
                `;
                listEl.appendChild(li);
            });
        }

        // Counters
        const total   = keys.length;
        const checked = keys.filter(id => allItems[id].done).length;
        const pct     = total ? Math.round(checked / total * 100) : 0;
        countEl.innerText = total + (total === 1 ? ' producto' : ' productos');
        pctEl.innerText   = pct + '%';
    }

    function escHtml(str) {
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ
    function add() {
        const input = document.getElementById('item-in');
        const val = input.value.trim();
        if (!val) return;
        dbRef.push({ name: val, done: false, by: myName || 'Anon', qty: 1 });
        input.value = '';
        input.focus();
    }

    window.toggle = (id, s) => dbRef.child(id).update({ done: !s });
    window.changeQty = (id, current, delta) => {
        const newQty = Math.max(1, current + delta);
        dbRef.child(id).update({ qty: newQty });
    };
    window.del    = (id)    => dbRef.child(id).remove();

    document.getElementById('add-btn').onclick = add;
    document.getElementById('item-in').onkeydown = e => { if (e.key === 'Enter') add(); };

    document.getElementById('clear').onclick = () => {
        Object.keys(allItems).forEach(id => {
            if (allItems[id].done) dbRef.child(id).remove();
        });
    };

    // ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ
    document.getElementById('filter-bar').addEventListener('click', e => {
        const btn = e.target.closest('.cat-btn');
        if (!btn) return;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filter = btn.dataset.f;
        renderList();
    });

    // ‚îÄ‚îÄ DEBUG PANEL ‚îÄ‚îÄ
    let debugLines = [];
    function debugLog(msg) {
        console.log(msg);
        debugLines.push(new Date().toLocaleTimeString('es-AR', {hour:'2-digit',minute:'2-digit',second:'2-digit'}) + ' ' + msg);
        const panel = document.getElementById('debug-panel');
        if (panel) {
            panel.style.display = 'block';
            panel.innerText = debugLines.slice(-8).join('\n');
        }
    }

    // ‚îÄ‚îÄ PHOTO REFERENCE ‚îÄ‚îÄ
    document.getElementById('scan-btn').onclick = () => {
        const panel = document.getElementById('photo-panel');
        if (panel.style.display !== 'none') {
            panel.style.display = 'none';
        } else {
            document.getElementById('photo-input').click();
        }
    };

    document.getElementById('photo-close').onclick = () => {
        document.getElementById('photo-panel').style.display = 'none';
    };

    document.getElementById('photo-input').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            document.getElementById('photo-display').src = ev.target.result;
            document.getElementById('photo-panel').style.display = 'block';
        };
        reader.readAsDataURL(file);
        e.target.value = '';
    };

        // PWA Service Worker
    if ('serviceWorker' in navigator) {
        const swCode = `self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('fetch',e=>e.respondWith(fetch(e.request).catch(()=>new Response('',{status:503}))));`;
        const blob = new Blob([swCode], {type:'application/javascript'});
        navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(()=>{});
    }
</script>
</body>
</html>
